{% extends "my_canteen/base.html" %}
{% load static %}
{% block content %}
<div class="container my-5">

    <!-- Item Info -->
    <div class="row">
        <div class="col-md-5">
            {% if item.image %}
                <img src="{{ item.image.url }}" class="img-fluid rounded shadow" alt="{{ item.name }}">
            {% endif %}
        </div>
        <div class="col-md-7">
            <h2>{{ item.name }}</h2>
            <p class="text-muted">{{ item.description }}</p>
            <p><strong>Price:</strong> ‡ß≥{{ item.price }}</p>

            <p>
                ‚≠ê <strong>{{ avg_rating }}</strong> / 5  
                <small>({{ total_reviews }} reviews)</small>
            </p>

            <form method="post" action="{% url 'add_to_cart' item.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">üõí Add to Cart</button>
            </form>
        </div>
    </div>

    <hr>

    <!-- Reviews Section -->
    <div class="mt-5">
        <h4>Customer Feedback</h4>

        {% if reviews %}
            {% for review in reviews %}
                <div class="border p-3 mb-3 rounded">
                    <strong>{{ review.user.username }}</strong> rated
                    <span class="text-warning">
                        {% for i in "12345" %}
                            {% if i|add:"0"|floatformat:0 <= review.rating %}
                                ‚òÖ
                            {% else %}
                                ‚òÜ
                            {% endif %}
                        {% endfor %}
                    </span>
                    <p>{{ review.comment }}</p>
                    <small class="text-muted">{{ review.created_at|date:"F j, Y, g:i a" }}</small>

                    {% if review.user == request.user %}
                        <div class="mt-2">
                            <a href="{% url 'edit_review' item.id %}" class="btn btn-sm btn-outline-warning">Edit</a>
                            <form action="{% url 'delete_review' item.id %}" method="POST" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No reviews yet. Be the first to share your feedback!</p>
        {% endif %}
    </div>

    <hr>

    <!-- Write Review Section -->
    <div class="mt-4">
        {% if user.is_authenticated %}
            {% if can_review %}
                <h5>Write Your Review</h5>
                <form method="POST" action="{% url 'submit_review' item.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="rating" class="form-label">Your Rating (1-5)</label>
                        <select name="rating" id="rating" class="form-select" required>
                            <option value="">Select</option>
                            {% for i in "12345" %}
                                <option value="{{ i }}">{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Your Feedback</label>
                        <textarea name="comment" id="comment" rows="3" class="form-control" placeholder="Write your thoughts..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
            {% elif already %}
                <p class="text-info">You already reviewed this item.</p>
            {% else %}
                <p class="text-muted">You can review this item after purchasing it.</p>
            {% endif %}
        {% else %}
            <p class="text-muted">Please <a href="{% url 'login' %}">login</a> to give a review.</p>
        {% endif %}
    </div>

</div>
{% endblock %}
