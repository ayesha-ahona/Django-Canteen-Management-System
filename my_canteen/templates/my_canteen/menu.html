{% extends "my_canteen/base.html" %}
{% block content %}

<h2>üçΩÔ∏è Our Menu</h2>

<form method="get" class="search-filter-form">
  <input type="text" name="q" placeholder="Search food..." value="{{ q }}">
  <input type="number" name="min_price" placeholder="Min Price" value="{{ min_price }}">
  <input type="number" name="max_price" placeholder="Max Price" value="{{ max_price }}">
  <select name="sort">
    <option value="">Sort</option>
    <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price Low ‚Üí High</option>
    <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price High ‚Üí Low</option>
  </select>
  {% if active_cat %}
    <input type="hidden" name="cat" value="{{ active_cat }}">
  {% endif %}
  <button type="submit">Apply</button>
</form>

<div class="chip-row">
  <a
    href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if sort %}sort={{ sort }}{% endif %}"
    class="chip {% if not active_cat %}active{% endif %}"
  >All</a>
  {% for cat in categories %}
    <a
      href="?cat={{ cat.id }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
      class="chip {% if active_cat == cat.id|stringformat:'s' %}active{% endif %}"
    >{{ cat.name }}</a>
  {% endfor %}
</div>


<div class="card-grid">
  {% for item in items %}
    <div class="card">
      <a class="card-media" href="{% url 'item_detail' item.id %}">
        {% if item.image %}
          <img src="{{ item.image.url }}" alt="{{ item.name }}">
        {% else %}
          <img src="https://via.placeholder.com/300x200?text=No+Image" alt="{{ item.name }}">
        {% endif %}
        {% if item.is_popular %}<span class="badge">Popular</span>{% endif %}
        {% if item.stock <= 0 %}<span class="badge badge-red">Out</span>{% endif %}
      </a>

      <div class="card-details">
        <a class="product-name" href="{% url 'item_detail' item.id %}">{{ item.name }}</a>
        <p class="price">‡ß≥{{ item.price }}</p>

        <div class="rating" title="Rating">
          {% if item.rating_avg %}
            <span class="stars">
              {% for i in "12345" %}
                {% if forloop.counter <= item.rating_avg|floatformat:0 %}
                  <span class="star filled">‚òÖ</span>
                {% else %}
                  <span class="star">‚òÜ</span>
                {% endif %}
              {% endfor %}
            </span>
            <span class="rating-value">{{ item.rating_avg|floatformat:1 }}</span>
            {% if item.rating_count %}<span class="review-count">({{ item.rating_count }})</span>{% endif %}
          {% else %}
            <span class="no-rating">No reviews yet</span>
          {% endif %}
        </div>
      </div>

      <div class="card-footer">
        {% if item.stock > 0 %}
          <a href="{% url 'add_to_cart' item.id %}" class="btn btn-primary">Add to Cart</a>
        {% else %}
          <p class="out-of-stock">Out of Stock</p>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p>No food items found.</p>
  {% endfor %}
</div>


{% if recommended %}
  <hr class="divider">
  <div class="recommended">
    <h3>‚≠ê Recommended For You</h3>
    <div class="card-grid">
      {% for item in recommended %}
        <div class="card">
          <a class="card-media" href="{% url 'item_detail' item.id %}">
            {% if item.image %}
              <img src="{{ item.image.url }}" alt="{{ item.name }}">
            {% else %}
              <img src="https://via.placeholder.com/300x200?text=No+Image" alt="{{ item.name }}">
            {% endif %}
          </a>
          <div class="card-details">
            <a class="product-name" href="{% url 'item_detail' item.id %}">{{ item.name }}</a>
            <p class="price">‡ß≥{{ item.price }}</p>

            <div class="rating" title="Rating">
              {% if item.rating_avg %}
                <span class="stars">
                  {% for i in "12345" %}
                    {% if forloop.counter <= item.rating_avg|floatformat:0 %}
                      <span class="star filled">‚òÖ</span>
                    {% else %}
                      <span class="star">‚òÜ</span>
                    {% endif %}
                  {% endfor %}
                </span>
                <span class="rating-value">{{ item.rating_avg|floatformat:1 }}</span>
                {% if item.rating_count %}<span class="review-count">({{ item.rating_count }})</span>{% endif %}
              {% else %}
                <span class="no-rating">No reviews yet</span>
              {% endif %}
            </div>

          </div>
          <div class="card-footer">
            {% if item.stock > 0 %}
              <a href="{% url 'add_to_cart' item.id %}" class="btn btn-primary">Add to Cart</a>
            {% else %}
              <p class="out-of-stock">Out of Stock</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% endblock %}