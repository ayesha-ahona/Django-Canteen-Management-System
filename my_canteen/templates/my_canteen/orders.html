{% extends "my_canteen/base.html" %}
{% load static %}

{% block content %}
<div class="container" style="max-width:1100px;">
  <h2 class="mb-3">
    {% if profile.role in "vendor admin" %}
      All Orders
    {% elif profile.role == "staff" %}
      Kitchen Queue
    {% else %}
      My Orders
    {% endif %}
  </h2>

  {% if orders %}
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th style="width:70px;">#</th>
          <th>User</th>
          <th>Items</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th style="width:220px;">Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for order in orders %}
        <tr>
          <td>#{{ order.id }}</td>
          <td>{{ order.user.username }}</td>
          <td>
            {% for oi in order.orderitem_set.all %}
              {{ oi.item.name }} × {{ oi.quantity }}{% if not forloop.last %}<br>{% endif %}
            {% endfor %}
          </td>
          <td>{{ order.total_price }} Tk</td>
          <td>{{ order.payment_status|capfirst }}</td>
          <td>
            {% if order.status == "completed" %}
              <span class="badge bg-success">Completed</span>
            {% elif order.status == "cancelled" %}
              <span class="badge bg-secondary">Cancelled</span>
            {% elif order.status == "ready" %}
              <span class="badge bg-info text-dark">Ready</span>
            {% elif order.status == "preparing" %}
              <span class="badge bg-warning text-dark">Preparing</span>
            {% elif order.status == "accepted" %}
              <span class="badge bg-primary">Accepted</span>
            {% else %}
              <span class="badge bg-dark">Pending</span>
            {% endif %}
          </td>
          <td>
            {# ---- Vendor/Admin management actions (তোমার আগের মত থাকুক) ---- #}
            {% if profile.role in "vendor admin" %}
              <a class="btn btn-sm btn-outline-primary mb-1" href="{% url 'order_accept' order.id %}">Accept</a>
              <a class="btn btn-sm btn-outline-warning mb-1" href="{% url 'order_preparing' order.id %}">Preparing</a>
              <a class="btn btn-sm btn-outline-info mb-1"    href="{% url 'order_ready' order.id %}">Ready</a>
              <a class="btn btn-sm btn-outline-secondary mb-1" href="{% url 'order_delivered' order.id %}">Delivered</a>
              <a class="btn btn-sm btn-outline-success mb-1"  href="{% url 'order_mark_paid' order.id %}">Mark Paid</a>
              <a class="btn btn-sm btn-danger mb-1"            href="{% url 'order_cancel' order.id %}"
                 onclick="return confirm('Cancel this order?');">Cancel</a>
              <a class="btn btn-sm btn-success mb-1"           href="{% url 'order_completed' order.id %}">Complete</a>
            {% else %}
              {# ---- End-user Smart Cancel: preparing-এর আগ পর্যন্ত ---- #}
              {% if order.id in cancelable_ids %}
                <a class="btn btn-sm btn-outline-danger"
                   href="{% url 'user_order_cancel' order.id %}"
                   onclick="return confirm('Cancel this order?');">
                   Cancel
                </a>
              {% else %}
                <span class="text-muted">No actions</span>
              {% endif %}
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-muted">No orders found.</p>
  {% endif %}
</div>
{% endblock %}
